<data>
<xpath expr="/t[@t-name='hr_payroll.report_payslip']" position="replace" mode="inner">
    <t t-call="web.html_container">
        <t t-foreach="docs" t-as="o">
            <t t-call="web.basic_layout">
                <div class="header" style="display: none;"/>
                <div class="footer" style="display: none;"/>
                <style>
                    .page {
                        font-family: "Courier New", monospace !important;
                        font-size: 12px !important;
                        line-height: 1.2 !important;
                        padding: 10px !important;
                        margin: 5mm !important;
                        color: black !important;
                    }
                    .header-line {
                        text-align: left;
                        margin-bottom: 2px;
                    }
                    .company-title {
                        text-align: center;
                        font-weight: bold;
                        margin: 5px 0;
                    }
                    .payslip-title {
                        text-align: center;
                        font-weight: bold;
                        margin: 5px 0;
                    }
                    .employee-info {
                        margin: 10px 0;
                    }
                    .salary-table {
                        width: 100%;
                        margin: 10px 0;
                        border-collapse: collapse;
                    }
                    .salary-table td {
                        border: 1px solid black;
                        padding: 4px;
                        vertical-align: top;
                    }
                    .amount-line {
                        text-align: right;
                    }
                    .employer-section {
                        margin-top: 15px;
                    }
                    .bank-info {
                        margin-top: 10px;
                    }
                    @media print {
                        .header, .footer {
                            display: none !important;
                        }
                    }
                </style>
                <div class="page">
                    <div class="header-line">
                        Release Date: <span t-esc="datetime.date.today().strftime('%d-%m-%Y')"/>
                    </div>
                    <div class="header-line">
                        Date: <span t-esc="datetime.datetime.now().strftime('%d-%m-%Y')"/> Time: <span t-esc="datetime.datetime.now().strftime('%H:%M:%S')"/> Page: 1
                    </div>
                    
                    <div class="company-title">
                        <span t-field="o.company_id.name"/> - Staff
                    </div>
                    
                    <div class="payslip-title">
                        PAYSLIP FOR THE MONTH OF <span t-esc="o.date_from.strftime('%B').upper()"/> <span t-esc="o.date_from.year"/>
                    </div>
                    
                    <div class="employee-info">
                        <div>EMP NO. <span t-field="o.employee_id.registration_number" t-if="o.employee_id.registration_number"/> <span t-field="o.employee_id.name"/></div>
                        <div>EPF NO. <span t-field="o.employee_id.x_studio_epf_no"/> DESIGNATION : <span t-field="o.employee_id.job_title"/></div>
                    </div>
                    
                    <!-- Calculate dynamic values -->
                    <t t-set="basic_salary" t-value="0"/>
                    <t t-set="gross_pay" t-value="0"/>
                    <t t-set="epf_employee" t-value="0"/>
                    <t t-set="total_deductions" t-value="0"/>
                    <t t-set="net_pay" t-value="0"/>
                    <t t-set="epf_employer" t-value="0"/>
                    <t t-set="etf_employer" t-value="0"/>
                    
                    <!-- Calculate earnings and deductions from payslip lines -->
                    <t t-foreach="o.line_ids" t-as="line">
                        <t t-if="line.salary_rule_id.code == 'BASIC'" t-set="basic_salary" t-value="basic_salary + line.total"/>
                        <t t-if="line.category_id.code == 'GROSS'" t-set="gross_pay" t-value="gross_pay + line.total"/>
                        <t t-if="line.salary_rule_id.code == 'EPF_EE'" t-set="epf_employee" t-value="epf_employee + abs(line.total)"/>
                        <t t-if="line.category_id.code == 'DED'" t-set="total_deductions" t-value="total_deductions + abs(line.total)"/>
                        <t t-if="line.category_id.code == 'NET'" t-set="net_pay" t-value="net_pay + line.total"/>
                        <t t-if="line.salary_rule_id.code == 'EPF_ER' or line.salary_rule_id.code == 'EPF_COMP' or 'EPF' in line.salary_rule_id.code and line.category_id.code == 'COMP'" t-set="epf_employer" t-value="epf_employer + line.total"/>
                        <t t-if="line.salary_rule_id.code == 'ETF' or line.salary_rule_id.code == 'ETF_COMP' or 'ETF' in line.salary_rule_id.code and line.category_id.code == 'COMP'" t-set="etf_employer" t-value="etf_employer + line.total"/>
                    </t>
                    
                    <table class="salary-table">
                        <tbody>
                            <tr>
                                <td width="50%">
                                    GROSS SAL <span style="float: right;"><t t-esc="'{:,.2f}'.format(basic_salary)"/></span>
                                </td>
                                <td width="50%">
                                    <!-- Show other deductions here, excluding EPF -->
                                    <t t-set="first_deduction" t-value="o.line_ids.filtered(lambda x: x.category_id.code == 'DED' and x.code != 'EPF_EE')[:1]"/>
                                    <t t-if="first_deduction">
                                        <span t-field="first_deduction[0].name"/> <span style="float: right;"><t t-esc="'{:,.2f}'.format(abs(first_deduction[0].total))"/></span>
                                    </t>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    PAY FOR EPF <span style="float: right;"><t t-esc="'{:,.2f}'.format(basic_salary)"/></span><br/>
                                    <t t-foreach="o.line_ids.filtered(lambda x: x.category_id.code == 'ALW' and x.code != 'BASIC' and x.name != 'Ex-gratia')" t-as="allowance">
                                        <div><span t-field="allowance.name"/> <span style="float: right;"><t t-esc="'{:,.2f}'.format(allowance.total)"/></span></div>
                                    </t>
                                </td>
                                <td>
                                    <t t-foreach="o.line_ids.filtered(lambda x: x.category_id.code == 'DED' and x.code != 'EPF_EE' and 'EPF' not in x.name)" t-as="deduction">
                                        <div><span t-field="deduction.name"/> <span style="float: right;"><t t-esc="'{:,.2f}'.format(abs(deduction.total))"/></span></div>
                                    </t>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    GROSS PAY <span style="float: right;"><t t-esc="'{:,.2f}'.format(gross_pay)"/></span>
                                </td>
                                <td>
                                    TOTAL DEDUCTIONS <span style="float: right;"><t t-esc="'{:,.2f}'.format(total_deductions)"/></span>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    Basic Salary <span style="float: right;"><t t-esc="'{:,.2f}'.format(basic_salary)"/></span>
                                </td>
                                <td>
                                    <t t-set="ex_gratia" t-value="o.line_ids.filtered(lambda x: x.name == 'Ex-gratia')"/>
                                    <t t-if="ex_gratia">
                                        Ex-gratia <span style="float: right;"><t t-esc="'{:,.2f}'.format(ex_gratia[0].total)"/></span>
                                    </t>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    
                                </td>
                                <td>
                                    NET PAY <span style="float: right;"><t t-esc="'{:,.2f}'.format(net_pay)"/></span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="employer-section">
                        <strong>EMPLOYERS CONTRIBUTION</strong>
                        <div style="margin-left: 20px;">
                            <!-- If dynamic calculation fails, fall back to manual calculation -->
                            <t t-set="etf_calculated" t-value="basic_salary * 0.03 if etf_employer == 0 else etf_employer"/>
                            <t t-set="epf_calculated" t-value="basic_salary * 0.12 if epf_employer == 0 else epf_employer"/>
                            ETF 3% <t t-esc="'{:,.2f}'.format(etf_calculated)"/><br/>
                            EPF 12% <t t-esc="'{:,.2f}'.format(epf_calculated)"/>
                        </div>
                    </div>
                    
                    <div class="bank-info">
                        BANK ACC.NO. <span t-field="o.employee_id.bank_account_id.acc_number" t-if="o.employee_id.bank_account_id"/> OF <span t-field="o.employee_id.bank_account_id.bank_name" t-if="o.employee_id.bank_account_id"/>
                    </div>
                </div>
            </t>
        </t>
    </t>
</xpath>
</data>
